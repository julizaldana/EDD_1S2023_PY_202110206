<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador | EDD GoDrive | Fase 3</title>
<style>

    .body{
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100vw;
        height: 100vh;
        background: #28AC9C;
        color: #fff;    
    }

    img {
        width: 20%;
    }

    h1 {
        color: black;
        font-family: 'Courier New', sans-serif; /*tipograf√≠a texto*/        
        font-size: 18px;           
    }

    .images {
        display: block;
        margin: 0 auto;
        place-items: center;
    }


    .center {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 40%;
    }


    hr {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    border: 2;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    }


</style>

</head>
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
<body>
<header class="p-3 bg-success text-white">
    <h1>
        Dashboard Para El Administrador - Fase 3
        <img src="edddrive.png" alt="edddrive logo" width="130" height="130"> 
    </h1>
</header>
<br>
<div class="container">
    <div class="input-group mb-3">
        <button class="btn btn-outline-success" type="button" onclick="cargarAVLtoHash()">Cargar Alumnos de AVL</button>
        <button class="btn btn-outline-success" type="button" onclick="motrarTablaHash()">Mostrar Tabla Hash</button>
        <button class="btn btn-outline-success" type="button" onclick="">Manejo de Archivos</button>
        <button class="btn btn-outline-success" type="button" onclick="mostarBloqueInicial()">Mostrar Bloques</button>
        <button class="btn btn-outline-success" type="button" onclick="grafica_de_bloques()">Grafica Bloques</button>
    </div>
    <div>
        <div style="width: 22rem;">
            <label class="form-label" for="customFile">Carga Masiva con JSON</label>
            <input type="file" class="form-control bg-success text-white" id="input" autocompleted="">
        </div>
    </div>
    <div class="mb-3">
        <span class="input-group-text">Reporte Bloques</span>
        <textarea  readonly="readonly" rows="8" type="text" class="form-control" id="reporte-bloques"></textarea>
    </div>
    <div class="mb-3">
        <button class="btn btn-outline-success" type="button" onclick="bloqueAnterior()">Bloque Anterior</button>
        <button class="btn btn-outline-success" type="button" onclick="bloqueSiguiente()">Bloque Siguiente</button> 
    </div>
</div>
<div class="images">
    <img id="imagebloques" class="center">
</div>

<script>


let indiceBloqueActual = 0; // Se utiliza una variable global para poder mantener el bloque actual como indice



function actualizarInfoTextArea(index) {
  var bloques = localStorage.getItem('bloques');
  const data = JSON.parse(bloques)

  const obj = data[index];
  if (obj) { 
    let cadena = "Index: " + obj.index;
    cadena += "\nTimeStamp: " + obj.timestamp;
    cadena += "\nEmisor: " + obj.transmitter;
    cadena += "\nReceptor: " + obj.receiver;
    cadena += "\nMensaje: " + obj.message;
    cadena += "\nPreviousHash: " + obj.previoushash;
    cadena += "\nHash: " + obj.hash;

    document.getElementById("reporte-bloques").value = cadena;
  } 
}

function mostarBloqueInicial() {
  var bloques = localStorage.getItem('bloques');
  const data = JSON.parse(bloques)

  const obj = data[indiceBloqueActual];
  if (obj) { 
    let cadena = "Index: " + obj.index;
    cadena += "\nTimeStamp: " + obj.timestamp;
    cadena += "\nEmisor: " + obj.transmitter;
    cadena += "\nReceptor: " + obj.receiver;
    cadena += "\nMensaje: " + obj.message;
    cadena += "\nPreviousHash: " + obj.previoushash;
    cadena += "\nHash: " + obj.hash;

    document.getElementById("reporte-bloques").value = cadena; 
  }
}


function bloqueSiguiente() {
  indiceBloqueActual++;
  actualizarInfoTextArea(indiceBloqueActual);
}

function bloqueAnterior() {
  indiceBloqueActual--;
  actualizarInfoTextArea(indiceBloqueActual);
}




 function graficaBloques() {
    var bloques = localStorage.getItem('bloques');
    const data = JSON.parse(bloques)

        var cadena = "";
        for (var i = 0; i < data.length; i++) { 
            const obj = data[i];
            if (obj) { 
                console.log(obj.timestamp + obj.transmitter + obj.receiver + obj.message)
                cadena = cadena + "nodo" + i + "[width=1.4 label=\"" +  "TimeStamp:  " + obj.timestamp + "\\n" + " Emisor: " + obj.transmitter + "\\n"  + " Receptor: " + obj.receiver + "\\n"  + "PreviousHash: " + obj.previoushash + "\"];\n"
            }      
        }
        for (var i = 0; i < data.length-1; i++) {
            cadena = cadena + "nodo" + i + " -> nodo" + (i+1) + ";\n"
        } 
        return cadena;
 }


 function grafica_de_bloques(){
    console.log("Grafica Bloques")
    let url = 'https://quickchart.io/graphviz?graph=';
    let body = "digraph {\n" +  "rankdir=LR; \n" + "node[shape = record]; \n" 
    body = body + graficaBloques()
    body = body +  "}\n"
    console.log(body)
    $("#imagebloques").attr("src", url + body);
}




</script>

<script src="tablahash.js"></script>
<script src="./blockchainblocks.js"></script>
</body>
</html>
